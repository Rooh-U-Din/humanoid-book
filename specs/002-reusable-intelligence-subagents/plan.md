# Implementation Plan: Reusable Intelligence with Subagents

**Branch**: `002-reusable-intelligence-subagents` | **Date**: 2025-12-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-reusable-intelligence-subagents/spec.md`

## Summary

Implement a modular AI skill system for the Physical AI Book that enables reusable intelligence capabilities across all chapters. The system provides 5 core skills (explain, translate, debug, navigate, personalize) through a unified API with centralized authentication, logging, and extensibility support. Built on existing GeminiService and BetterAuth infrastructure.

## Technical Context

**Language/Version**: TypeScript 5.x (frontend), Python 3.11 (backend)
**Primary Dependencies**: FastAPI, SQLAlchemy, Pydantic (backend); React, Docusaurus (frontend)
**Storage**: Neon Serverless PostgreSQL (skill_invocations table)
**Testing**: pytest (backend), Jest (frontend)
**Target Platform**: Web (Docusaurus static site + FastAPI API)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <5s skill response time, <100ms skill list latency
**Constraints**: Free-tier Gemini API, existing BetterAuth cookie auth
**Scale/Scope**: ~1000 users, 5 initial skills, extensible to 10+

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Accuracy and Reliability | PASS | Skills use RAG context from book content only |
| II. Modular, Spec-Driven Development | PASS | Full spec/plan/tasks workflow followed |
| III. Maintainability and Clarity | PASS | Clean skill interface pattern, documented |
| IV. End-to-End Consistency | PASS | Reuses existing patterns (GeminiService, auth) |
| V. Security and Privacy | PASS | BetterAuth required, no PII in logs |

**Key Standards Compliance**:
- [x] FastAPI backend with async support
- [x] Neon Serverless Postgres for logging
- [x] Environment variables documented
- [x] Zero paid dependencies (Gemini free tier)

## Project Structure

### Documentation (this feature)

```text
specs/002-reusable-intelligence-subagents/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research output
├── data-model.md        # Phase 1 data model
├── quickstart.md        # Phase 1 setup guide
├── contracts/           # Phase 1 API contracts
│   └── api-openapi.yaml
└── tasks.md             # Phase 2 output (generated by /sp.tasks)
```

### Source Code (repository root)

```text
# Web application structure

backend/
├── src/
│   ├── models/
│   │   ├── database.py      # SQLAlchemy models (SkillInvocation extended)
│   │   └── skills.py        # Pydantic skill request/response models
│   ├── services/
│   │   ├── skills/          # NEW: Skill implementations
│   │   │   ├── __init__.py
│   │   │   ├── base.py          # BaseSkill abstract class, AgentContext
│   │   │   ├── registry.py      # SkillRegistry singleton
│   │   │   ├── explain_skill.py
│   │   │   ├── translate_skill.py
│   │   │   ├── debug_skill.py
│   │   │   ├── navigate_skill.py
│   │   │   └── personalize_skill.py
│   │   ├── agent_orchestrator.py  # NEW: Central orchestrator
│   │   ├── gemini_service.py      # Existing: LLM provider
│   │   └── session_validator.py   # Existing: BetterAuth validation
│   ├── api/
│   │   ├── skills_routes.py   # NEW: /api/skills/* endpoints
│   │   └── auth_routes.py     # Existing
│   └── migrations/
│       └── 003_add_subagent_fields.py  # NEW: Extend skill_invocations
└── tests/
    ├── unit/
    │   └── test_skills.py
    └── integration/
        └── test_skills_api.py

src/                          # Docusaurus frontend
├── components/
│   └── Skills/              # NEW: Skill UI components
│       ├── SkillPanel.tsx       # Main skill invocation panel
│       ├── SkillButton.tsx      # Individual skill button
│       ├── SkillResult.tsx      # Result display
│       ├── api.ts               # Skill API client
│       └── index.ts
├── hooks/
│   └── useSkill.ts          # NEW: Skill invocation hook
└── theme/
    └── DocItem/
        └── index.tsx         # Existing: Add skill panel integration
```

**Structure Decision**: Web application structure extending existing backend/frontend split. New `skills/` directory contains modular skill implementations following registry pattern.

## Complexity Tracking

No constitution violations requiring justification.

## Architecture Decisions

### AD-001: Dictionary-Based Skill Registry

**Decision**: Use Python dictionary with class-based skill implementations following a common abstract base class.

**Rationale**:
- Simple and Pythonic approach
- Works with FastAPI's dependency injection
- Skills registered at startup, no dynamic loading complexity
- Extensible via configuration

**Alternatives Rejected**:
- Plugin-based dynamic loading: Overkill for 5-10 skills
- Database-driven registry: Adds latency, unnecessary complexity

### AD-002: AgentOrchestrator Service Pattern

**Decision**: Central orchestrator service that routes all skill invocations.

**Rationale**:
- Single entry point simplifies authentication and logging
- Context building centralized
- Each skill handler remains focused (single responsibility)

### AD-003: GeminiService with Skill-Specific Prompts

**Decision**: Reuse existing GeminiService with tailored prompts per skill.

**Rationale**:
- Already integrated and working
- Free tier sufficient
- No additional API dependencies

## Dependencies

### Backend (existing + new)
| Package | Version | Purpose |
|---------|---------|---------|
| (existing) | - | FastAPI, SQLAlchemy, Pydantic |
| google-generativeai | ^0.3.0 | Gemini LLM (existing) |

### Frontend (existing + new)
| Package | Version | Purpose |
|---------|---------|---------|
| (existing) | - | React, Docusaurus |

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Gemini API rate limits | Medium | Medium | Implement client-side rate limiting, cache common requests |
| Skill execution timeout | Low | Medium | 30s timeout, graceful error handling |
| User confusion on skill choice | Low | Low | Clear skill descriptions, smart defaults |

## Implementation Phases

### Phase 1: Backend Skill Infrastructure
- Create skill base classes and registry
- Implement AgentOrchestrator
- Run database migration
- Create skills_routes.py

### Phase 2: Core Skills Implementation
- Implement ExplainSkill
- Implement TranslateSkill
- Implement DebugSkill
- Implement NavigateSkill
- Implement PersonalizeSkill

### Phase 3: Frontend Integration
- Create Skills API client
- Create SkillPanel component
- Integrate with text selection
- Add skill buttons to DocItem

### Phase 4: Testing & Polish
- Unit tests for all skills
- Integration tests for API
- End-to-end skill invocation test
- Performance validation

## Generated Artifacts

| Artifact | Path | Status |
|----------|------|--------|
| Research | `research.md` | Complete |
| Data Model | `data-model.md` | Complete |
| API Contract | `contracts/api-openapi.yaml` | Complete |
| Quickstart | `quickstart.md` | Complete |
| Tasks | `tasks.md` | Pending (/sp.tasks) |

## Next Steps

Run `/sp.tasks` to generate the implementation task list based on this plan.

# Implementation Plan: BetterAuth Strict Access Control

**Branch**: `001-betterauth-access-control` | **Date**: 2025-12-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-betterauth-access-control/spec.md`

## Summary

Implement BetterAuth-based authentication with strict access control for the Physical AI Book. Users must signup/signin before accessing any chapter, module, or interactive content. The solution uses BetterAuth client SDK (`better-auth/react`) on the Docusaurus frontend with custom FastAPI session validation on the backend. Optional background questionnaire after signup supports personalization features.

## Technical Context

**Language/Version**: TypeScript 5.x (frontend), Python 3.11 (backend)
**Primary Dependencies**: better-auth, @better-auth/react (frontend); FastAPI, bcrypt, SQLAlchemy (backend)
**Storage**: Neon Serverless PostgreSQL (shared BetterAuth + application tables)
**Testing**: Jest/React Testing Library (frontend); pytest (backend)
**Target Platform**: Web (Docusaurus static site + FastAPI API)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <100ms session validation, <500ms signup/signin
**Constraints**: Free-tier Neon Postgres (0.5GB), no paid auth services
**Scale/Scope**: ~1000 users, 8+ chapters protected

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Accuracy and Reliability | PASS | BetterAuth is battle-tested, well-documented |
| II. Modular, Spec-Driven Development | PASS | Full spec/plan/tasks workflow followed |
| III. Maintainability and Clarity | PASS | Standard patterns, clear separation |
| IV. End-to-End Consistency | PASS | Shared DB, consistent models |
| V. Security and Privacy | PASS | Bcrypt hashing, httpOnly cookies, no credential enumeration |

**Key Standards Compliance**:
- [x] Docusaurus v3+ with MDX v3 support
- [x] FastAPI backend with async support
- [x] Neon Serverless Postgres
- [x] Environment variables documented in .env.example
- [x] Zero paid dependencies

## Project Structure

### Documentation (this feature)

```text
specs/001-betterauth-access-control/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research output
├── data-model.md        # Phase 1 data model
├── quickstart.md        # Phase 1 setup guide
├── contracts/           # Phase 1 API contracts
│   └── api-openapi.yaml
└── tasks.md             # Phase 2 output (generated by /sp.tasks)
```

### Source Code (repository root)

```text
# Web application structure

backend/
├── src/
│   ├── models/
│   │   ├── database.py      # SQLAlchemy models (User, Session, Account, etc.)
│   │   └── auth.py          # Pydantic request/response models
│   ├── services/
│   │   ├── session_validator.py  # BetterAuth session validation
│   │   └── auth_service.py       # Auth business logic
│   ├── api/
│   │   ├── auth_routes.py        # /api/auth/* endpoints
│   │   └── profile_routes.py     # /api/profile/* endpoints
│   └── migrations/
│       └── 001_betterauth_access_control.sql
└── tests/
    ├── unit/
    └── integration/

src/                          # Docusaurus frontend
├── lib/
│   └── auth-client.ts        # BetterAuth client configuration
├── components/
│   └── Auth/
│       ├── AuthProvider.tsx      # Auth context provider
│       ├── ProtectedContent.tsx  # Content guard component
│       ├── LoginPrompt.tsx       # Login/signup prompt
│       ├── SignUpModal.tsx       # Signup form
│       ├── SignInModal.tsx       # Signin form
│       └── BackgroundQuestionnaire.tsx  # Post-signup questionnaire
├── theme/
│   ├── Root.tsx              # Wraps app with AuthProvider
│   └── DocItem/
│       └── Content/
│           └── index.tsx     # Protected content wrapper
└── pages/
    └── profile.tsx           # User profile page
```

**Structure Decision**: Web application structure selected. Frontend uses Docusaurus React components with BetterAuth client SDK. Backend uses FastAPI with custom session validation against shared PostgreSQL database.

## Complexity Tracking

No constitution violations requiring justification.

## Architecture Decisions

### AD-001: BetterAuth Client-Side, Custom Backend Validation

**Decision**: Use BetterAuth client SDK on frontend, custom session validation on FastAPI backend.

**Rationale**:
- BetterAuth is TypeScript/Node.js only - no Python SDK
- FastAPI can validate sessions by reading shared database
- Avoids adding Node.js middleware layer
- Single database as source of truth

**Alternatives Rejected**:
- Node.js auth proxy: Adds latency and complexity
- JWT-only: Loses BetterAuth session management benefits

### AD-002: Client-Side Content Guards + API Protection

**Decision**: Dual protection - client-side guards for UX, server-side API auth for security.

**Rationale**:
- Docusaurus generates static HTML - cannot fully protect at build time
- Client guards provide good UX (redirect to login)
- Server API is the true security boundary
- Protected content fetched via authenticated API calls

### AD-003: Cookie-Based Session Storage

**Decision**: Use httpOnly cookies with 7-day expiration, 1-day refresh.

**Rationale**:
- httpOnly prevents XSS attacks on session token
- 7-day expiration balances security and UX
- 1-day refresh keeps active users logged in
- SameSite=lax prevents CSRF for most cases

## Dependencies

### Frontend
| Package | Version | Purpose |
|---------|---------|---------|
| better-auth | ^1.x | Core auth library |
| @better-auth/react | ^1.x | React hooks (useSession) |

### Backend
| Package | Version | Purpose |
|---------|---------|---------|
| bcrypt | ^4.x | Password hashing |
| python-jose[cryptography] | ^3.x | JWT handling (optional) |
| (existing) | - | FastAPI, SQLAlchemy, Pydantic |

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| BetterAuth API changes | Low | Medium | Pin version, monitor releases |
| Session sync issues | Low | Medium | Single DB source of truth |
| Content bypass | Medium | High | Server API is security boundary |
| Performance degradation | Low | Medium | Cookie caching, connection pooling |

## Implementation Phases

### Phase 1: Database & Models (Foundation)
- Create migration for BetterAuth tables
- Add SQLAlchemy models
- Add Pydantic models

### Phase 2: Backend Auth Endpoints
- Implement session validator
- Create signup/signin/signout endpoints
- Create session endpoint

### Phase 3: Frontend Auth Client
- Configure BetterAuth client
- Create AuthProvider
- Implement useAuth hook

### Phase 4: Content Protection
- Create ProtectedContent wrapper
- Update DocItem theme
- Implement login prompt

### Phase 5: Auth UI Components
- SignUpModal with validation
- SignInModal with error handling
- User menu / auth status

### Phase 6: Profile & Questionnaire
- Profile API endpoints
- Questionnaire modal
- Profile page

### Phase 7: Integration & Testing
- End-to-end flow testing
- Security review
- Performance validation

## Generated Artifacts

| Artifact | Path | Status |
|----------|------|--------|
| Research | `research.md` | Complete |
| Data Model | `data-model.md` | Complete |
| API Contract | `contracts/api-openapi.yaml` | Complete |
| Quickstart | `quickstart.md` | Complete |
| Tasks | `tasks.md` | Pending (/sp.tasks) |

## Next Steps

Run `/sp.tasks` to generate the implementation task list based on this plan.
